<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI 뉴스 콘텐츠 검수 및 배포 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
  <style>
    :root { --primary-color:#159CCA; --secondary-color:#008f4c; --bg-color:#f4f7f9; }
    body{font-family:'Inter','Segoe UI',sans-serif;text-align:center;padding:20px;background-color:var(--bg-color);color:#333;}
    #editor-container,#content-display,#meta-display{max-width:900px;margin:20px auto;text-align:left;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);background:#fff;padding:20px;}
    #editor-container{height:400px;display:none;padding:0;box-shadow:none;}
    .quill{border-radius:0 0 12px 12px;overflow:hidden;}
    button{margin:8px;padding:10px 20px;font-size:16px;cursor:pointer;border:none;border-radius:8px;transition:all .2s ease;font-weight:600;}
    #loading{font-size:18px;color:#888;margin-top:20px;}
    #content-display{min-height:400px;background:#fff;padding:30px;border:1px solid #e0e0e0;}
    .edit-buttons{display:none;}
    #meta-display{padding:30px 20px 10px 20px;background-color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.05);}
    .meta-company{font-size:16px;font-weight:500;color:#777;margin-bottom:5px;}
    .meta-title{font-size:28px;font-weight:700;color:#111;margin-bottom:4px;}
    #title-input{font-size:24px;font-weight:700;width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;display:none;box-sizing:border-box;}
    .meta-date{font-size:14px;color:#999;margin-bottom:16px;}
    .meta-status{font-size:18px;font-weight:700;padding:5px 10px;border-radius:6px;display:inline-block;margin-bottom:15px;margin-top:10px;}
    .status-pending{background-color:#fce38a;color:#333;}
    .status-approved{background-color:var(--secondary-color);color:#fff;}
    .status-retry{background-color:#e74c3c;color:#fff;}
    .meta-tags{font-size:14px;color:var(--primary-color);margin-top:30px;border-top:1px solid #ddd;padding-top:10px;}
    #buttons button:nth-child(2){background-color:var(--secondary-color);color:#fff;}
    #buttons button:nth-child(3){background-color:#e74c3c;color:#fff;}
    #buttons button:hover{opacity:.9;transform:translateY(-1px);}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;}
    .modal-content{background:#fff;padding:30px;border-radius:10px;max-width:400px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.3);}
    .modal-buttons button{margin:5px;min-width:100px;}
    .modal-buttons .confirm-btn{background-color:var(--secondary-color);color:#fff;}
    .modal-buttons .cancel-btn{background-color:#ccc;color:#333;}
    .hidden{display:none;}
    .debug-log{margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;font-size:12px;color:#666;text-align:left;max-width:900px;margin-left:auto;margin-right:auto;max-height:200px;overflow-y:auto;}
  </style>
</head>
<body>
  <h1>AI 뉴스 콘텐츠 검수</h1>

  <div id="meta-display">
    <div class="meta-company" id="meta-company"></div>
    <div class="meta-title" id="meta-title"></div>
    <input type="text" id="title-input"/>
    <div class="meta-date" id="meta-date"></div>
    <div class="meta-status" id="meta-status"></div>
  </div>

  <div id="loading">⏳ 불러오는 중입니다...</div>
  <div id="content-display"></div>
  <div id="editor-container"></div>

  <div id="buttons" style="display:none;">
    <button onclick="toggleEditMode()">✏️ 수정</button>
    <button onclick="showConfirmation('approve')">✅ 최종 승인 및 배포</button>
    <button onclick="showConfirmation('retry')">🔄 수정 요청</button>
  </div>

  <div id="edit-buttons" class="edit-buttons">
    <button onclick="applyEdit()">📝 수정 완료</button>
    <button onclick="cancelEdit()">❌ 취소</button>
    <button onclick="triggerImageUpload()">🖼️ 이미지 추가</button>
  </div>

  <input type="file" id="image-upload" accept="image/*" style="display:none;"/>

  <div id="custom-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <p id="modal-message" class="mb-4 text-lg"></p>
      <div id="modal-buttons" class="modal-buttons"></div>
    </div>
  </div>

  <div id="debug-log" class="debug-log" style="display:none;"></div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    // ✅ 디버그 로그 함수
    const debugLog = document.getElementById("debug-log");
    function addDebugLog(msg) {
      debugLog.style.display = "block";
      const time = new Date().toLocaleTimeString();
      debugLog.innerHTML += `<div>[${time}] ${msg}</div>`;
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    // ✅ 유틸 함수 개선
    function normalizeKey(str){
      if(!str) return '';
      // 디코딩 후 재정규화 (중복 인코딩 방지)
      try {
        str = decodeURIComponent(str);
      } catch(e) {
        // 이미 디코딩된 상태
      }
      return str.normalize('NFC')
        .replace(/\u00A0/g,' ')
        .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g,'-')
        .replace(/[ \t\u2000-\u200B\u3000]+/g,' ')
        .trim();
    }
    
    function encodeOnce(s){
      // 이미 인코딩되어 있는지 확인
      try {
        if (decodeURIComponent(s) !== s) {
          return s; // 이미 인코딩됨
        }
      } catch(e) {}
      return encodeURIComponent(s);
    }
    
    const collapse=s=>s.replace(/-+/g,'-').replace(/\s+/g,' ').trim();
    const stripWeird=s=>s.replace(/[^\w\s\-가-힣0-9]/g,'').replace(/\s+/g,' ').trim();
    const removeSpaces=s=>s.replace(/\s+/g,'');
    const hyphenToSpace=s=>s.replace(/-/g,' ');
    const spaceToHyphen=s=>s.replace(/\s+/g,'-');

    // 모달
    const customModal=document.getElementById("custom-modal");
    const modalMessage=document.getElementById("modal-message");
    const modalButtons=document.getElementById("modal-buttons");
    function showModal(msg,isConfirm=false,onConfirm=null){
      modalMessage.innerText=msg;
      modalButtons.innerHTML='';
      customModal.classList.remove('hidden');
      if(isConfirm&&onConfirm){
        const ok=document.createElement('button');ok.innerText='확인';ok.className='confirm-btn';
        ok.onclick=()=>{customModal.classList.add('hidden');onConfirm();};
        const cancel=document.createElement('button');cancel.innerText='취소';cancel.className='cancel-btn';
        cancel.onclick=()=>customModal.classList.add('hidden');
        modalButtons.append(ok,cancel);
      }else{
        const close=document.createElement('button');close.innerText='닫기';close.className='cancel-btn';
        close.onclick=()=>customModal.classList.add('hidden');
        modalButtons.appendChild(close);
      }
    }
    function showConfirmation(a){showModal(`정말 "${a==='approve'?'승인 및 배포':'수정 요청'}" 하시겠습니까?`,true,()=>sendWebhook(a));}

    // URL 파라미터 정규화
    const urlParams=new URLSearchParams(window.location.search);
    const company=normalizeKey(urlParams.get("company")||"");
    const postId=normalizeKey(urlParams.get("post_id")||"");
    
    addDebugLog(`📥 원본 파라미터 - Company: "${company}", Post ID: "${postId}"`);
    
    const apiEndpoint="https://news-review-system.mktg-95f.workers.dev/";
    const webhookApprove="https://hook.eu1.make.com/okhlmq986f82n94qvfyafsxpybx1pvdl";
    const webhookRetry="https://hook.eu1.make.com/lgbmpgnnaqljrfrzlahbviis82oyii15";

    const loading=document.getElementById("loading");
    const contentDisplay=document.getElementById("content-display");
    const editorContainer=document.getElementById("editor-container");
    const buttons=document.getElementById("buttons");
    const editButtons=document.getElementById("edit-buttons");
    const metaTitle=document.getElementById("meta-title");
    const titleInput=document.getElementById("title-input");
    const metaCompany=document.getElementById("meta-company");
    const metaDate=document.getElementById("meta-date");
    const metaStatus=document.getElementById("meta-status");
    let quill,htmlContent="",currentContent="",airtableRecordId="";

    async function fetchRecordWithFallback(baseEndpoint,company,postId){
      // 더 많은 변형 시도
      const tries=[
        // 원본
        {c:company,p:postId,desc:"원본"},
        // 공백/하이픈 정규화
        {c:collapse(company),p:collapse(postId),desc:"collapse"},
        // 특수문자 제거
        {c:stripWeird(company),p:stripWeird(postId),desc:"stripWeird"},
        // 공백 제거
        {c:removeSpaces(company),p:removeSpaces(postId),desc:"removeSpaces"},
        // 하이픈을 공백으로
        {c:hyphenToSpace(company),p:hyphenToSpace(postId),desc:"hyphenToSpace"},
        // 공백을 하이픈으로
        {c:spaceToHyphen(company),p:spaceToHyphen(postId),desc:"spaceToHyphen"},
        // 조합: collapse + stripWeird
        {c:stripWeird(collapse(company)),p:stripWeird(collapse(postId)),desc:"collapse+stripWeird"},
        // Post ID만 변형 (Company는 원본)
        {c:company,p:collapse(postId),desc:"원본Company+collapsePostId"},
        {c:company,p:stripWeird(postId),desc:"원본Company+stripWeirdPostId"},
        {c:company,p:removeSpaces(postId),desc:"원본Company+removeSpacesPostId"},
        // Company만 변형 (Post ID는 원본)
        {c:collapse(company),p:postId,desc:"collapseCompany+원본PostId"},
        {c:stripWeird(company),p:postId,desc:"stripWeirdCompany+원본PostId"},
      ];
      
      let lastErr="";
      let attemptNum = 0;
      
      for(const t of tries){
        attemptNum++;
        const target=`${baseEndpoint}?company=${encodeOnce(t.c)}&post_id=${encodeOnce(t.p)}`;
        const proxy=`https://corsproxy.io/?${encodeURIComponent(target)}`;
        
        addDebugLog(`🔍 시도 ${attemptNum}/${tries.length} (${t.desc}) - Company: "${t.c}", Post ID: "${t.p}"`);
        
        try{
          const res=await fetch(proxy);
          if(!res.ok){
            lastErr=await res.text();
            addDebugLog(`❌ 시도 ${attemptNum} 실패: ${res.status} ${res.statusText}`);
            continue;
          }
          const data=await res.json();
          if(data&&data.fields){
            addDebugLog(`✅ 시도 ${attemptNum} 성공! (${t.desc})`);
            return{data,urlUsed:target,proxyUsed:proxy};
          }
          addDebugLog(`⚠️ 시도 ${attemptNum}: 응답은 받았으나 데이터 없음`);
        }catch(e){
          lastErr=e.message;
          addDebugLog(`❌ 시도 ${attemptNum} 예외: ${e.message}`);
        }
      }
      
      throw new Error(`❌ No matching record found after ${tries.length} attempts. Last error: ${lastErr}`);
    }

    (async()=>{
      if(!company||!postId){
        loading.innerHTML="<span style='color:red;'>❌ URL 파라미터 누락</span>";
        addDebugLog("❌ Company 또는 Post ID 파라미터가 누락되었습니다.");
        return;
      }
      
      try{
        const {data,urlUsed,proxyUsed}=await fetchRecordWithFallback(apiEndpoint,company,postId);
        loading.style.display="none";
        const r=data.fields;airtableRecordId=data.id;
        
        addDebugLog(`✅ 레코드 ID: ${airtableRecordId}`);
        
        htmlContent=r["본문 html"]||"";currentContent=htmlContent;
        metaCompany.innerText=r["기업명"]||"";metaTitle.innerText=r["기사 제목"]||"제목 없음";
        titleInput.value=r["기사 제목"]||"";metaDate.innerText=r["송출 희망일"]?`송출 희망일: ${new Date(r["송출 희망일"]).toLocaleDateString("ko-KR")}`:"송출 희망일 미정";
        const s=r["기사 상태"]||"상태 정보 없음";
        metaStatus.innerText=`기사 상태: ${s}`;metaStatus.className="meta-status";
        if(s.includes("대기"))metaStatus.classList.add("status-pending");
        else if(s.includes("승인"))metaStatus.classList.add("status-approved");
        else if(s.includes("수정"))metaStatus.classList.add("status-retry");
        const kw=r["핵심 키워드"]||"";
        contentDisplay.innerHTML=`<div style="max-width:900px;margin:0 auto;">${htmlContent}${kw?`<div class="meta-tags">#${kw.replaceAll(",", " #")}</div>`:""}</div>`;
        buttons.style.display="block";
        quill=new Quill("#editor-container",{theme:"snow",modules:{toolbar:[[{"header":[1,2,false]}],["bold","italic","underline"],["link","blockquote","code-block"],[{"list":"ordered"},{"list":"bullet"}],["image"]] }});
        quill.clipboard.dangerouslyPasteHTML(htmlContent);
        
        addDebugLog(`✅ 콘텐츠 로드 완료 - 제목: "${r["기사 제목"]}"`);
        
        const dbg=document.createElement('div');dbg.style.cssText="margin-top:8px;color:#bbb;font-size:12px;text-align:center;";
        dbg.innerHTML=`[성공한 요청 URL]: <a href="${urlUsed}" target="_blank" style="color:#159CCA;">${urlUsed}</a>`;
        document.body.appendChild(dbg);
      }catch(e){
        console.error(e);
        loading.innerHTML=`<p style="color:red;">❌ 데이터 불러오기 오류 발생: ${e.message}</p><p style="font-size:14px;color:#666;margin-top:10px;">(Cloudflare Worker가 요청한 Company='${company}' / Post ID='${postId}' 에 해당하는 레코드를 찾지 못했거나 네트워크 오류가 발생했습니다.)</p>`;
        addDebugLog(`🔥 최종 실패: ${e.message}`);
      }
    })();

    function toggleEditMode(){editorContainer.style.display="block";contentDisplay.style.display="none";buttons.style.display="none";editButtons.style.display="block";metaTitle.style.display="none";titleInput.style.display="block";quill.clipboard.dangerouslyPasteHTML(currentContent);}
    function applyEdit(){currentContent=quill.root.innerHTML;const nt=titleInput.value||"제목 없음";metaTitle.innerText=nt;contentDisplay.innerHTML=`<div style="max-width:900px;margin:0 auto;">${currentContent}</div>`;editorContainer.style.display="none";contentDisplay.style.display="block";buttons.style.display="block";editButtons.style.display="none";metaTitle.style.display="block";titleInput.style.display="none";}
    function cancelEdit(){editorContainer.style.display="none";contentDisplay.style.display="block";buttons.style.display="block";editButtons.style.display="none";metaTitle.style.display="block";titleInput.style.display="none";}
    function sendWebhook(a){const url=a==="approve"?webhookApprove:webhookRetry;if(!airtableRecordId){showModal("❌ Record ID 누락",false);return;}const p={record_id:airtableRecordId,post_id:postId,company:company,action:a,content_type:"news"};if(a==="approve"){p.edited_title=titleInput.value||"제목 없음";p.edited_html=`<div style="max-width:900px;margin:0 auto;">${currentContent}</div>`;}fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}).then(r=>{if(!r.ok)throw new Error(r.statusText);showModal("요청 전송 완료");addDebugLog(`✅ Webhook 전송 완료 (${a})`);}).catch(e=>{showModal("오류: "+e.message);addDebugLog(`❌ Webhook 전송 실패: ${e.message}`);});}
    function triggerImageUpload(){document.getElementById("image-upload").click();}
  </script>
</body>
</html>
