<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI ë‰´ìŠ¤ ì½˜í…ì¸  ê²€ìˆ˜ ë° ë°°í¬ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
  <style>
    :root { --primary-color:#159CCA; --secondary-color:#008f4c; --bg-color:#f4f7f9; }
    body{font-family:'Inter','Segoe UI',sans-serif;text-align:center;padding:20px;background-color:var(--bg-color);color:#333;}
    #editor-container,#content-display,#meta-display{max-width:900px;margin:20px auto;text-align:left;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);background:#fff;padding:20px;}
    #editor-container{height:400px;display:none;padding:0;box-shadow:none;}
    .quill{border-radius:0 0 12px 12px;overflow:hidden;}
    button{margin:8px;padding:10px 20px;font-size:16px;cursor:pointer;border:none;border-radius:8px;transition:all .2s ease;font-weight:600;}
    #loading{font-size:18px;color:#888;margin-top:20px;}
    #content-display{min-height:400px;background:#fff;padding:30px;border:1px solid #e0e0e0;}
    .edit-buttons{display:none;}
    #meta-display{padding:30px 20px 10px 20px;background-color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.05);}
    .meta-company{font-size:16px;font-weight:500;color:#777;margin-bottom:5px;}
    .meta-title{font-size:28px;font-weight:700;color:#111;margin-bottom:4px;}
    #title-input{font-size:24px;font-weight:700;width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;display:none;box-sizing:border-box;}
    .meta-date{font-size:14px;color:#999;margin-bottom:16px;}
    .meta-status{font-size:18px;font-weight:700;padding:5px 10px;border-radius:6px;display:inline-block;margin-bottom:15px;margin-top:10px;}
    .status-pending{background-color:#fce38a;color:#333;}
    .status-approved{background-color:var(--secondary-color);color:#fff;}
    .status-retry{background-color:#e74c3c;color:#fff;}
    .meta-tags{font-size:14px;color:var(--primary-color);margin-top:30px;border-top:1px solid #ddd;padding-top:10px;}
    #buttons button:nth-child(2){background-color:var(--secondary-color);color:#fff;}
    #buttons button:nth-child(3){background-color:#e74c3c;color:#fff;}
    #buttons button:hover{opacity:.9;transform:translateY(-1px);}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;}
    .modal-content{background:#fff;padding:30px;border-radius:10px;max-width:400px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.3);}
    .modal-buttons button{margin:5px;min-width:100px;}
    .modal-buttons .confirm-btn{background-color:var(--secondary-color);color:#fff;}
    .modal-buttons .cancel-btn{background-color:#ccc;color:#333;}
    .hidden{display:none;}
    .debug-log{margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;font-size:12px;color:#666;text-align:left;max-width:900px;margin-left:auto;margin-right:auto;max-height:200px;overflow-y:auto;}
  </style>
</head>
<body>
  <h1>AI ë‰´ìŠ¤ ì½˜í…ì¸  ê²€ìˆ˜</h1>

  <div id="meta-display">
    <div class="meta-company" id="meta-company"></div>
    <div class="meta-title" id="meta-title"></div>
    <input type="text" id="title-input"/>
    <div class="meta-date" id="meta-date"></div>
    <div class="meta-status" id="meta-status"></div>
  </div>

  <div id="loading">â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
  <div id="content-display"></div>
  <div id="editor-container"></div>

  <div id="buttons" style="display:none;">
    <button onclick="toggleEditMode()">âœï¸ ìˆ˜ì •</button>
    <button onclick="showConfirmation('approve')">âœ… ìµœì¢… ìŠ¹ì¸ ë° ë°°í¬</button>
    <button onclick="showConfirmation('retry')">ğŸ”„ ìˆ˜ì • ìš”ì²­</button>
  </div>

  <div id="edit-buttons" class="edit-buttons">
    <button onclick="applyEdit()">ğŸ“ ìˆ˜ì • ì™„ë£Œ</button>
    <button onclick="cancelEdit()">âŒ ì·¨ì†Œ</button>
    <button onclick="triggerImageUpload()">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì¶”ê°€</button>
  </div>

  <input type="file" id="image-upload" accept="image/*" style="display:none;"/>

  <div id="custom-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <p id="modal-message" class="mb-4 text-lg"></p>
      <div id="modal-buttons" class="modal-buttons"></div>
    </div>
  </div>

  <div id="debug-log" class="debug-log" style="display:none;"></div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    // âœ… ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜
    const debugLog = document.getElementById("debug-log");
    function addDebugLog(msg) {
      debugLog.style.display = "block";
      const time = new Date().toLocaleTimeString();
      debugLog.innerHTML += `<div>[${time}] ${msg}</div>`;
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    // âœ… ìœ í‹¸ í•¨ìˆ˜ ê°œì„ 
    function normalizeKey(str){
      if(!str) return '';
      // ë””ì½”ë”© í›„ ì¬ì •ê·œí™” (ì¤‘ë³µ ì¸ì½”ë”© ë°©ì§€)
      try {
        str = decodeURIComponent(str);
      } catch(e) {
        // ì´ë¯¸ ë””ì½”ë”©ëœ ìƒíƒœ
      }
      return str.normalize('NFC')
        .replace(/\u00A0/g,' ')
        .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g,'-')
        .replace(/[ \t\u2000-\u200B\u3000]+/g,' ')
        .trim();
    }
    
    function encodeOnce(s){
      // ì´ë¯¸ ì¸ì½”ë”©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
      try {
        if (decodeURIComponent(s) !== s) {
          return s; // ì´ë¯¸ ì¸ì½”ë”©ë¨
        }
      } catch(e) {}
      return encodeURIComponent(s);
    }
    
    const collapse=s=>s.replace(/-+/g,'-').replace(/\s+/g,' ').trim();
    const stripWeird=s=>s.replace(/[^\w\s\-ê°€-í£0-9]/g,'').replace(/\s+/g,' ').trim();
    const removeSpaces=s=>s.replace(/\s+/g,'');
    const hyphenToSpace=s=>s.replace(/-/g,' ');
    const spaceToHyphen=s=>s.replace(/\s+/g,'-');

    // ëª¨ë‹¬
    const customModal=document.getElementById("custom-modal");
    const modalMessage=document.getElementById("modal-message");
    const modalButtons=document.getElementById("modal-buttons");
    function showModal(msg,isConfirm=false,onConfirm=null){
      modalMessage.innerText=msg;
      modalButtons.innerHTML='';
      customModal.classList.remove('hidden');
      if(isConfirm&&onConfirm){
        const ok=document.createElement('button');ok.innerText='í™•ì¸';ok.className='confirm-btn';
        ok.onclick=()=>{customModal.classList.add('hidden');onConfirm();};
        const cancel=document.createElement('button');cancel.innerText='ì·¨ì†Œ';cancel.className='cancel-btn';
        cancel.onclick=()=>customModal.classList.add('hidden');
        modalButtons.append(ok,cancel);
      }else{
        const close=document.createElement('button');close.innerText='ë‹«ê¸°';close.className='cancel-btn';
        close.onclick=()=>customModal.classList.add('hidden');
        modalButtons.appendChild(close);
      }
    }
    function showConfirmation(a){showModal(`ì •ë§ "${a==='approve'?'ìŠ¹ì¸ ë° ë°°í¬':'ìˆ˜ì • ìš”ì²­'}" í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,true,()=>sendWebhook(a));}

    // URL íŒŒë¼ë¯¸í„° ì •ê·œí™”
    const urlParams=new URLSearchParams(window.location.search);
    const company=normalizeKey(urlParams.get("company")||"");
    const postId=normalizeKey(urlParams.get("post_id")||"");
    
    addDebugLog(`ğŸ“¥ ì›ë³¸ íŒŒë¼ë¯¸í„° - Company: "${company}", Post ID: "${postId}"`);
    
    const apiEndpoint="https://news-review-system.mktg-95f.workers.dev/";
    const webhookApprove="https://hook.eu1.make.com/okhlmq986f82n94qvfyafsxpybx1pvdl";
    const webhookRetry="https://hook.eu1.make.com/lgbmpgnnaqljrfrzlahbviis82oyii15";

    const loading=document.getElementById("loading");
    const contentDisplay=document.getElementById("content-display");
    const editorContainer=document.getElementById("editor-container");
    const buttons=document.getElementById("buttons");
    const editButtons=document.getElementById("edit-buttons");
    const metaTitle=document.getElementById("meta-title");
    const titleInput=document.getElementById("title-input");
    const metaCompany=document.getElementById("meta-company");
    const metaDate=document.getElementById("meta-date");
    const metaStatus=document.getElementById("meta-status");
    let quill,htmlContent="",currentContent="",airtableRecordId="";

    async function fetchRecordWithFallback(baseEndpoint,company,postId){
      // ë” ë§ì€ ë³€í˜• ì‹œë„
      const tries=[
        // ì›ë³¸
        {c:company,p:postId,desc:"ì›ë³¸"},
        // ê³µë°±/í•˜ì´í”ˆ ì •ê·œí™”
        {c:collapse(company),p:collapse(postId),desc:"collapse"},
        // íŠ¹ìˆ˜ë¬¸ì ì œê±°
        {c:stripWeird(company),p:stripWeird(postId),desc:"stripWeird"},
        // ê³µë°± ì œê±°
        {c:removeSpaces(company),p:removeSpaces(postId),desc:"removeSpaces"},
        // í•˜ì´í”ˆì„ ê³µë°±ìœ¼ë¡œ
        {c:hyphenToSpace(company),p:hyphenToSpace(postId),desc:"hyphenToSpace"},
        // ê³µë°±ì„ í•˜ì´í”ˆìœ¼ë¡œ
        {c:spaceToHyphen(company),p:spaceToHyphen(postId),desc:"spaceToHyphen"},
        // ì¡°í•©: collapse + stripWeird
        {c:stripWeird(collapse(company)),p:stripWeird(collapse(postId)),desc:"collapse+stripWeird"},
        // Post IDë§Œ ë³€í˜• (CompanyëŠ” ì›ë³¸)
        {c:company,p:collapse(postId),desc:"ì›ë³¸Company+collapsePostId"},
        {c:company,p:stripWeird(postId),desc:"ì›ë³¸Company+stripWeirdPostId"},
        {c:company,p:removeSpaces(postId),desc:"ì›ë³¸Company+removeSpacesPostId"},
        // Companyë§Œ ë³€í˜• (Post IDëŠ” ì›ë³¸)
        {c:collapse(company),p:postId,desc:"collapseCompany+ì›ë³¸PostId"},
        {c:stripWeird(company),p:postId,desc:"stripWeirdCompany+ì›ë³¸PostId"},
      ];
      
      let lastErr="";
      let attemptNum = 0;
      
      for(const t of tries){
        attemptNum++;
        const target=`${baseEndpoint}?company=${encodeOnce(t.c)}&post_id=${encodeOnce(t.p)}`;
        const proxy=`https://corsproxy.io/?${encodeURIComponent(target)}`;
        
        addDebugLog(`ğŸ” ì‹œë„ ${attemptNum}/${tries.length} (${t.desc}) - Company: "${t.c}", Post ID: "${t.p}"`);
        
        try{
          const res=await fetch(proxy);
          if(!res.ok){
            lastErr=await res.text();
            addDebugLog(`âŒ ì‹œë„ ${attemptNum} ì‹¤íŒ¨: ${res.status} ${res.statusText}`);
            continue;
          }
          const data=await res.json();
          if(data&&data.fields){
            addDebugLog(`âœ… ì‹œë„ ${attemptNum} ì„±ê³µ! (${t.desc})`);
            return{data,urlUsed:target,proxyUsed:proxy};
          }
          addDebugLog(`âš ï¸ ì‹œë„ ${attemptNum}: ì‘ë‹µì€ ë°›ì•˜ìœ¼ë‚˜ ë°ì´í„° ì—†ìŒ`);
        }catch(e){
          lastErr=e.message;
          addDebugLog(`âŒ ì‹œë„ ${attemptNum} ì˜ˆì™¸: ${e.message}`);
        }
      }
      
      throw new Error(`âŒ No matching record found after ${tries.length} attempts. Last error: ${lastErr}`);
    }

    (async()=>{
      if(!company||!postId){
        loading.innerHTML="<span style='color:red;'>âŒ URL íŒŒë¼ë¯¸í„° ëˆ„ë½</span>";
        addDebugLog("âŒ Company ë˜ëŠ” Post ID íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }
      
      try{
        const {data,urlUsed,proxyUsed}=await fetchRecordWithFallback(apiEndpoint,company,postId);
        loading.style.display="none";
        const r=data.fields;airtableRecordId=data.id;
        
        addDebugLog(`âœ… ë ˆì½”ë“œ ID: ${airtableRecordId}`);
        
        htmlContent=r["ë³¸ë¬¸ html"]||"";currentContent=htmlContent;
        metaCompany.innerText=r["ê¸°ì—…ëª…"]||"";metaTitle.innerText=r["ê¸°ì‚¬ ì œëª©"]||"ì œëª© ì—†ìŒ";
        titleInput.value=r["ê¸°ì‚¬ ì œëª©"]||"";metaDate.innerText=r["ì†¡ì¶œ í¬ë§ì¼"]?`ì†¡ì¶œ í¬ë§ì¼: ${new Date(r["ì†¡ì¶œ í¬ë§ì¼"]).toLocaleDateString("ko-KR")}`:"ì†¡ì¶œ í¬ë§ì¼ ë¯¸ì •";
        const s=r["ê¸°ì‚¬ ìƒíƒœ"]||"ìƒíƒœ ì •ë³´ ì—†ìŒ";
        metaStatus.innerText=`ê¸°ì‚¬ ìƒíƒœ: ${s}`;metaStatus.className="meta-status";
        if(s.includes("ëŒ€ê¸°"))metaStatus.classList.add("status-pending");
        else if(s.includes("ìŠ¹ì¸"))metaStatus.classList.add("status-approved");
        else if(s.includes("ìˆ˜ì •"))metaStatus.classList.add("status-retry");
        const kw=r["í•µì‹¬ í‚¤ì›Œë“œ"]||"";
        contentDisplay.innerHTML=`<div style="max-width:900px;margin:0 auto;">${htmlContent}${kw?`<div class="meta-tags">#${kw.replaceAll(",", " #")}</div>`:""}</div>`;
        buttons.style.display="block";
        quill=new Quill("#editor-container",{theme:"snow",modules:{toolbar:[[{"header":[1,2,false]}],["bold","italic","underline"],["link","blockquote","code-block"],[{"list":"ordered"},{"list":"bullet"}],["image"]] }});
        quill.clipboard.dangerouslyPasteHTML(htmlContent);
        
        addDebugLog(`âœ… ì½˜í…ì¸  ë¡œë“œ ì™„ë£Œ - ì œëª©: "${r["ê¸°ì‚¬ ì œëª©"]}"`);
        
        const dbg=document.createElement('div');dbg.style.cssText="margin-top:8px;color:#bbb;font-size:12px;text-align:center;";
        dbg.innerHTML=`[ì„±ê³µí•œ ìš”ì²­ URL]: <a href="${urlUsed}" target="_blank" style="color:#159CCA;">${urlUsed}</a>`;
        document.body.appendChild(dbg);
      }catch(e){
        console.error(e);
        loading.innerHTML=`<p style="color:red;">âŒ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜ ë°œìƒ: ${e.message}</p><p style="font-size:14px;color:#666;margin-top:10px;">(Cloudflare Workerê°€ ìš”ì²­í•œ Company='${company}' / Post ID='${postId}' ì— í•´ë‹¹í•˜ëŠ” ë ˆì½”ë“œë¥¼ ì°¾ì§€ ëª»í–ˆê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.)</p>`;
        addDebugLog(`ğŸ”¥ ìµœì¢… ì‹¤íŒ¨: ${e.message}`);
      }
    })();

    function toggleEditMode(){editorContainer.style.display="block";contentDisplay.style.display="none";buttons.style.display="none";editButtons.style.display="block";metaTitle.style.display="none";titleInput.style.display="block";quill.clipboard.dangerouslyPasteHTML(currentContent);}
    function applyEdit(){currentContent=quill.root.innerHTML;const nt=titleInput.value||"ì œëª© ì—†ìŒ";metaTitle.innerText=nt;contentDisplay.innerHTML=`<div style="max-width:900px;margin:0 auto;">${currentContent}</div>`;editorContainer.style.display="none";contentDisplay.style.display="block";buttons.style.display="block";editButtons.style.display="none";metaTitle.style.display="block";titleInput.style.display="none";}
    function cancelEdit(){editorContainer.style.display="none";contentDisplay.style.display="block";buttons.style.display="block";editButtons.style.display="none";metaTitle.style.display="block";titleInput.style.display="none";}
    function sendWebhook(a){const url=a==="approve"?webhookApprove:webhookRetry;if(!airtableRecordId){showModal("âŒ Record ID ëˆ„ë½",false);return;}const p={record_id:airtableRecordId,post_id:postId,company:company,action:a,content_type:"news"};if(a==="approve"){p.edited_title=titleInput.value||"ì œëª© ì—†ìŒ";p.edited_html=`<div style="max-width:900px;margin:0 auto;">${currentContent}</div>`;}fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}).then(r=>{if(!r.ok)throw new Error(r.statusText);showModal("ìš”ì²­ ì „ì†¡ ì™„ë£Œ");addDebugLog(`âœ… Webhook ì „ì†¡ ì™„ë£Œ (${a})`);}).catch(e=>{showModal("ì˜¤ë¥˜: "+e.message);addDebugLog(`âŒ Webhook ì „ì†¡ ì‹¤íŒ¨: ${e.message}`);});}
    function triggerImageUpload(){document.getElementById("image-upload").click();}
  </script>
</body>
</html>
