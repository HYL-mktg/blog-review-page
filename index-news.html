<script>
  const urlParams = new URLSearchParams(window.location.search);
  const company = urlParams.get("company");
  const postId = urlParams.get("post_id");

  const proxyEndpoint = "https://hyltest-airtable-news-content.mktg-95f.workers.dev/"; // ğŸ“Œ ë³€ê²½ëœ í”„ë¡ì‹œ URL

  const loading = document.getElementById("loading");
  const contentDisplay = document.getElementById("content-display");
  const metaDisplay = document.getElementById("meta-display");
  const editorContainer = document.getElementById("editor-container");
  const buttons = document.getElementById("buttons");
  const editButtons = document.getElementById("edit-buttons");

  let quill;
  let htmlContent = "";
  let currentContent = "";

  if (!company || !postId) {
    loading.innerHTML = "<span style='color:red;'>âŒ URLì— company ë˜ëŠ” post_idê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.</span>";
  } else {
    // âœ… post_idë§Œ ì „ë‹¬í•˜ì—¬ ë°±ì—”ë“œê°€ Airtable ìš”ì²­ ìˆ˜í–‰
    fetch(`${proxyEndpoint}?post_id=${encodeURIComponent(postId)}`)
      .then(res => res.json())
      .then(data => {
        loading.style.display = "none";
        if (!data || !data.fields) {
          contentDisplay.innerHTML = "<p>âŒ í•´ë‹¹ ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        const record = data.fields;
        htmlContent = record["ë‚´ìš©(html)"] || "";
        currentContent = htmlContent;

        const companyName = record["ê¸°ì—…ëª…"] || "";
        const title = record["ì½˜í…ì¸  ì œëª©"] || "ì œëª© ì—†ìŒ";
        const date = record["ì˜ˆì•½ ë‚ ì§œ"] ? new Date(record["ì˜ˆì•½ ë‚ ì§œ"]).toLocaleDateString("ko-KR") : "";
        const tags = record["Hashtag"] || "";

        metaDisplay.innerHTML = `
          <div class="meta-company">${companyName}</div>
          <div class="meta-title">${title}</div>
          <div class="meta-date">${date}</div>
        `;

        contentDisplay.innerHTML = htmlContent + (tags ? `<div class="meta-tags">#${tags.replaceAll(",", " #")}</div>` : "");

        buttons.style.display = "block";
        localStorage.setItem(`viewed_${company}_${postId}`, "true");

        quill = new Quill("#editor-container", {
          theme: "snow",
          placeholder: "ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”...",
          modules: {
            toolbar: [
              [{ header: [1, 2, false] }],
              ["bold", "italic", "underline"],
              ["link", "blockquote", "code-block"],
              [{ list: "ordered" }, { list: "bullet" }]
            ]
          }
        });

        quill.clipboard.dangerouslyPasteHTML(htmlContent);
      })
      .catch(() => loading.innerText = "âš ï¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜ ë°œìƒ");
  }
</script>
