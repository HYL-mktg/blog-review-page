<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
  // Quill 초기화
  const quill = new Quill("#editor-container", {
    theme: "snow",
    placeholder: "내용을 입력하세요...",
    modules: {
      toolbar: [
        [{ header: [1, 2, false] }],
        ["bold", "italic", "underline"],
        ["link", "blockquote", "code-block"],
        [{ list: "ordered" }, { list: "bullet" }]
      ]
    }
  });

  // 이미지 붙여넣기 처리
  quill.getModule('clipboard').addMatcher('img', function (node, delta) {
    const imageSrc = node.getAttribute('src');

    if (imageSrc.startsWith('data:image')) {
      uploadBase64ToCloudinary(imageSrc);
      return new Delta();  // base64 삽입은 막음
    }

    return delta;
  });

  // base64 → Blob → Cloudinary 업로드
  function uploadBase64ToCloudinary(base64Data) {
    const blob = base64ToBlob(base64Data);
    const file = new File([blob], 'image.png', { type: blob.type });

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "mktg_ai");

    fetch("https://api.cloudinary.com/v1_1/dte6zhuck/image/upload", {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(result => {
        const url = result.secure_url;
        const alt = "붙여넣은 이미지";
        const html = `<p style="text-align:center;"><img src="${url}" alt="${alt}" class="responsive-image" width="800" style="max-width:100%; height:auto;" /></p>`;
        const range = quill.getSelection(true);
        quill.clipboard.dangerouslyPasteHTML(range.index, html);
      })
      .catch(err => {
        console.error("Cloudinary 업로드 실패", err);
        alert("이미지 업로드에 실패했습니다.");
      });
  }

  // base64 → Blob 변환
  function base64ToBlob(base64) {
    const parts = base64.split(";base64,");
    const contentType = parts[0].split(":")[1];
    const raw = window.atob(parts[1]);
    const rawLength = raw.length;
    const uInt8Array = new Uint8Array(rawLength);

    for (let i = 0; i < rawLength; ++i) {
      uInt8Array[i] = raw.charCodeAt(i);
    }

    return new Blob([uInt8Array], { type: contentType });
  }
</script>
